<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-06 Sat 01:02 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Extending GoogleTest</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Xin Huang" />
<meta name="description" content="If you want to make your own unit test DSL, how to make use of googletest to do the execution &amp; reporting?"
 />
<link rel="stylesheet" href="/themes/github/style.css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Extending GoogleTest</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1b509a8">1. Behind the curtain</a>
<ul>
<li><a href="#org0e8b214">1.1. A basic version</a></li>
<li><a href="#orgb3437b9">1.2. The googletest version</a>
<ul>
<li><a href="#orgf658be7">1.2.1. Inside RegisterTestInfo</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org00bf614">2. Register our test</a></li>
</ul>
</div>
</div>
<p>
<i>Updates on 2019-03-30: Google is working on a refactory of <code>googletest</code>. Some detail in this post may vary, but you get the idea.</i>
</p>

<p>
Maybe you are tired of the syntax <a href="https://github.com/google/googletest">googletest</a> has chosen, so you deside to invent you own unit test DSL. 
But re-implementing the whole execution &amp; report part of a unit test framework would be too much, esp. you want to ship your "product" somewhere.
</p>

<p>
Then the option left would be extending an existing one, and [googletest] is a good candidate.
</p>
<div id="outline-container-org1b509a8" class="outline-2">
<h2 id="org1b509a8"><span class="section-number-2">1</span> Behind the curtain</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0e8b214" class="outline-3">
<h3 id="org0e8b214"><span class="section-number-3">1.1</span> A basic version</h3>
<div class="outline-text-3" id="text-1-1">
<p>
First of all, before extending googletest, we need to know what's behind the curtain.  
A typical unit test would be:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-keyword">class</span> <span class="org-type">Fixture</span> : <span class="org-keyword">public</span> ::<span class="org-constant">testing</span>::<span class="org-type">Test</span> {
};

<span class="org-function-name">TEST_F</span>(<span class="org-type">Fixture</span>, GIVEN_1_THEN_add_1_SHOULD_return_0) {
    ASSERT_EQ(0, 1 + 1);
}
</pre>
</div>

<p>
<i>Sorry for my bad math.</i>
</p>

<p>
In above code snippet, googletest does 3 things:  
</p>
<ol class="org-ol">
<li>Create a class inherited from <code>Fixture</code>.</li>
<li>Override a method in <code>Fixture</code>.</li>
<li>Execute some code to register the newly created class somewhere.</li>
</ol>

<p>
All the magic is done within macro <code>TEST_F</code>.  
If you are familiar with macro, it won't take a minute to figure out <code>TEST_F</code> actually expand to:  
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-comment-delimiter">/* </span><span class="org-comment">--------- Expand start -----------&gt; */</span>
<span class="org-keyword">class</span> <span class="org-type">prefixGIVEN_1_THEN_add_1_SHOULD_return_0postfix</span> {
    <span class="org-type">void</span> <span class="org-function-name">SomeMethodCalledWhenExecuteTest</span>();
};
<span class="org-type">void</span> <span class="org-constant">prefixGIVEN_1_THEN_add_1_SHOULD_return_0postfix</span>::<span class="org-function-name">SomeMethodCalledWhenExecuteTest</span>()
<span class="org-comment-delimiter">/* </span><span class="org-comment">&lt;-------- Expand end --------------&gt; */</span>
{
    ASSERT_EQ(0, 1 + 1);
}
</pre>
</div>

<p>
Now, we've done No. 1 and No. 2. But what about No. 3? How to execute some code outside the <code>main</code> function?  
The answer is simple: <b>Use global variables</b>, and perform registration in the construction of the variable:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-comment-delimiter">//</span><span class="org-comment">* &lt;--------- Expand start -----------&gt; *//</span>
<span class="org-keyword">class</span> <span class="org-type">prefixGIVEN_1_THEN_add_1_SHOULD_return_0postfix</span> {
    <span class="org-type">void</span> <span class="org-function-name">SomeMethodCalledWhenExecuteTest</span>();
};
<span class="org-type">prefixGIVEN_1_THEN_add_1_SHOULD_return_0postfix</span> <span class="org-variable-name">instance_GIVEN_1_THEN_add_1_SHOULD_return_0</span>;
<span class="org-type">void</span> <span class="org-constant">prefixGIVEN_1_THEN_add_1_SHOULD_return_0postfix</span>::<span class="org-function-name">SomeMethodCalledWhenExecuteTest</span>()
<span class="org-comment-delimiter">//</span><span class="org-comment">* &lt;-------- Expand end --------------&gt; *//</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb3437b9" class="outline-3">
<h3 id="orgb3437b9"><span class="section-number-3">1.2</span> The googletest version</h3>
<div class="outline-text-3" id="text-1-2">
<p>
This only demonstrate the basic idea of how `TEST<sub>F</sub>` works. Knowing this, we can find out how to extend googletest.
</p>

<p>
Watching the macro <code>TEST_F</code>, it does a bit more than our basic version:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-preprocessor">#define</span> <span class="org-function-name">GTEST_TEST_</span>(<span class="org-variable-name">test_case_name</span>, <span class="org-variable-name">test_name</span>, <span class="org-variable-name">parent_class</span>, <span class="org-variable-name">parent_id</span>)         \
<span class="org-keyword">class</span> GTEST_TEST_CLASS_NAME_(test_case_name, test_name) : <span class="org-keyword">public</span> parent_class { \
<span class="org-keyword">public</span>:                                                                         \
    <span class="org-variable-name">GTEST_TEST_CLASS_NAME_</span>(test_case_name, test_name)() {}                      \
<span class="org-keyword">private</span>:                                                                        \
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-variable-name">TestBody</span>();                                                    \
    <span class="org-keyword">static</span> ::<span class="org-constant">testing</span>::<span class="org-type">TestInfo</span>* <span class="org-keyword">const</span> <span class="org-variable-name">test_info_</span> GTEST_ATTRIBUTE_UNUSED_;       \
    GTEST_DISALLOW_COPY_AND_ASSIGN_(                                            \
        GTEST_TEST_CLASS_NAME_(test_case_name, test_name));                     \
};                                                                              \
</pre>
</div>

<p>
Above code defines the test class inherites from test fixture.
</p>

<p>
First, create the global variable:
</p>

<div class="org-src-container">
<pre class="src src-C++">::<span class="org-constant">testing</span>::<span class="org-type">TestInfo</span>* <span class="org-keyword">const</span> <span class="org-function-name">GTEST_TEST_CLASS_NAME_</span>(test_case_name, test_name)   \
  ::test_info_ =                                                               \
</pre>
</div>

<p>
Then, initialize the global variable:
</p>

<div class="org-src-container">
<pre class="src src-C++">::<span class="org-constant">testing</span>::<span class="org-constant">internal</span>::MakeAndRegisterTestInfo(                                  \
    #test_case_name, #test_name, <span class="org-constant">NULL</span>, <span class="org-constant">NULL</span>,                                   \
    (parent_id),                                                               \
    <span class="org-constant">parent_class</span>::SetUpTestCase,                                               \
    <span class="org-constant">parent_class</span>::TearDownTestCase,                                            \
    <span class="org-keyword">new</span> ::<span class="org-constant">testing</span>::<span class="org-constant">internal</span>::<span class="org-type">TestFactoryImpl</span>&lt;                                  \
        GTEST_TEST_CLASS_NAME_(test_case_name, test_name)&gt;);                   \
</pre>
</div>

<p>
Registration is performed inside <code>::testing::internal::MakeAndRegisterTestInfo</code>.
</p>

<p>
At last, is the <b>TestBody</b> stub, which connects real test code:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">void</span> <span class="org-function-name">GTEST_TEST_CLASS_NAME_</span>(test_case_name, test_name)::TestBody()
</pre>
</div>
</div>
<div id="outline-container-orgf658be7" class="outline-4">
<h4 id="orgf658be7"><span class="section-number-4">1.2.1</span> Inside RegisterTestInfo</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Let's take a closer look at what happened inside <code>MakeAndRegisterTestInfo</code>:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">TestInfo</span>* <span class="org-function-name">MakeAndRegisterTestInfo</span>(
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">test_case_name</span>,
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">name</span>,
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type_param</span>,
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">value_param</span>,
    <span class="org-type">TypeId</span> <span class="org-variable-name">fixture_class_id</span>,
    <span class="org-type">SetUpTestCaseFunc</span> <span class="org-variable-name">set_up_tc</span>,                <span class="org-comment-delimiter">// </span><span class="org-comment">Set up for the first of fixture class.</span>
    <span class="org-type">TearDownTestCaseFunc</span> <span class="org-variable-name">tear_down_tc</span>,          <span class="org-comment-delimiter">// </span><span class="org-comment">Tear down after execute of all tests in a fixture.</span>
    <span class="org-type">TestFactoryBase</span>* <span class="org-variable-name">factory</span>);                  <span class="org-comment-delimiter">// </span><span class="org-comment">Factory creates the test class instances.</span>
</pre>
</div>

<p>
First 2 parameters are easy to tell from their name, last 3 are also not difficult.  
<code>type_param</code> and <code>value_param</code> are both passed as <code>NULL</code> in <code>TEST_F</code> macro, so we can ignore them until we really get some problems.
</p>

<p>
Then, what is <code>fixture_class_id</code>? If we are using a different model from googletest, what should the value be?   
By searching the code, we can easily find out the type id is used to tell a test going to run whether is the first one under a fixture. 
If it is, then the <code>tear_down_tc</code> of previous fixture and <code>set_up_tc</code> of the fixture should be called.  
So if you don't care about it, ignore it.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org00bf614" class="outline-2">
<h2 id="org00bf614"><span class="section-number-2">2</span> Register our test</h2>
<div class="outline-text-2" id="text-2">
<p>
After all the work, it is clear that all the macro makes googletest "user interface". 
If we want to connect our unit test DSL with googletest, register the test via <code>MakeAndRegisterTestInfo</code>.
</p>

<p>
Now we are ready to let our test sneaks in. Here is the complete code: (C++ 11)
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-keyword">class</span> <span class="org-type">NoFixture</span> {};
<span class="org-type">void</span> <span class="org-function-name">nop</span>() {}

<span class="org-keyword">class</span> <span class="org-type">FunctionTest</span> : <span class="org-keyword">public</span> ::<span class="org-constant">testing</span>::<span class="org-type">Test</span> {
<span class="org-keyword">public</span>:
    <span class="org-function-name">FunctionTest</span>(<span class="org-type">function</span>&lt;<span class="org-type">void</span>()&gt; <span class="org-variable-name">function</span>)
        : function_(function)
    {}
<span class="org-keyword">private</span>:
    <span class="org-keyword">const</span> <span class="org-type">function</span>&lt;<span class="org-type">void</span>()&gt; <span class="org-variable-name">function_</span>;
    <span class="org-type">void</span> <span class="org-function-name">TestBody</span>() <span class="org-keyword">override</span> { function_(); }
};

<span class="org-keyword">class</span> <span class="org-type">TestFactory</span> : <span class="org-keyword">public</span> ::<span class="org-constant">testing</span>::<span class="org-constant">internal</span>::<span class="org-type">TestFactoryBase</span> {
<span class="org-keyword">public</span>:
    <span class="org-function-name">TestFactory</span>(<span class="org-type">function</span>&lt;<span class="org-type">void</span>()&gt; <span class="org-variable-name">function</span>)
        : function_(function) {}
    ::<span class="org-constant">testing</span>::<span class="org-type">Test</span>* <span class="org-function-name">CreateTest</span>() <span class="org-keyword">override</span> {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">FunctionTest</span>(function_);
    }
<span class="org-keyword">private</span>:
    <span class="org-keyword">const</span> <span class="org-type">function</span>&lt;<span class="org-type">void</span>()&gt; <span class="org-variable-name">function_</span>;
};

<span class="org-type">void</span> <span class="org-function-name">Register</span>(<span class="org-keyword">const</span> <span class="org-type">string</span>&amp; <span class="org-variable-name">test_name</span>, <span class="org-keyword">const</span> <span class="org-type">string</span>&amp; <span class="org-variable-name">case_name</span>, <span class="org-type">function</span>&lt;<span class="org-type">void</span>()&gt; <span class="org-variable-name">test</span>) {
    <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-variable-name">fixture_class_id</span> = ::<span class="org-constant">testing</span>::<span class="org-constant">internal</span>::GetTypeId&lt;<span class="org-type">NoFixture</span>&gt;();
    ::<span class="org-constant">testing</span>::<span class="org-constant">internal</span>::MakeAndRegisterTestInfo(test_name.c_str(), case_name.c_str(), <span class="org-constant">nullptr</span>, <span class="org-constant">nullptr</span>,
        fixture_class_id, nop, nop, <span class="org-keyword">new</span> <span class="org-type">TestFactory</span>(test));
}
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<a href="/" class="left">Home</a><a href="#" class="right">Top</a>
</div>
</body>
</html>
