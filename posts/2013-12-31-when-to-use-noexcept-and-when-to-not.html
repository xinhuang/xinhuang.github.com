<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-06 Sat 01:02 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>When to Use noexcept And When to Not</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Xin Huang" />
<link rel="stylesheet" href="/themes/github/style.css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">When to Use noexcept And When to Not</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5d02d04">1. Intro to noexcept</a></li>
<li><a href="#org2fdc37c">2. <code>noexcept</code> and <code>move</code></a></li>
<li><a href="#orgd186ab2">3. noexcept is an interface specification</a></li>
<li><a href="#org15186d7">4. References</a></li>
</ul>
</div>
</div>
<p>
In C++ 11, a new keyword <code>noexcept</code> is introduced. Being a replacement of deprecated <code>throw()</code>, what is <code>noexcept</code> good for? 
When should it be used and when should be avoided?
</p>

<div id="outline-container-org5d02d04" class="outline-2">
<h2 id="org5d02d04"><span class="section-number-2">1</span> Intro to noexcept</h2>
<div class="outline-text-2" id="text-1">
<p>
<code>noexcept</code> is a function specifier. It is used to specify a function whether will throw exception or not. 
It can be used as following:
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">void</span> <span class="org-function-name">foo</span>() <span class="org-keyword">noexcept</span>;             <span class="org-comment-delimiter">// </span><span class="org-comment">a function specified as will never throw</span>
<span class="org-type">void</span> <span class="org-function-name">foo2</span>() <span class="org-keyword">noexcept</span>(<span class="org-constant">true</span>);      <span class="org-comment-delimiter">// </span><span class="org-comment">same as foo</span>
<span class="org-type">void</span> <span class="org-function-name">bar</span>();                      <span class="org-comment-delimiter">// </span><span class="org-comment">a function might throw exception</span>
<span class="org-type">void</span> <span class="org-function-name">bar2</span>() <span class="org-keyword">noexcept</span>(<span class="org-constant">false</span>);     <span class="org-comment-delimiter">// </span><span class="org-comment">same as bar</span>
</pre>
</div>

<p>
However, same as <code>throw()</code>, <code>noexcept</code> implies no compile-time check. 
What if a function specified with <code>noexcept</code> throws an exception?
</p>

<p>
Unlike <code>throw()</code>, if an exception is thrown out of a <code>noexcept</code> function, 
<code>std::unexpected</code> will not be called. Stack unwinding, during which destructor of stack allocated objects will be called, 
is <b>not guaranteed</b>. But <code>std::terminated</code> will be called immediately.
</p>

<p>
<code>noexcept</code> is to provide information for compiler, allow it to generate optimized code against non-throwing functions.
</p>

<pre class="example">
- Great, "noexcept" means more optimized code. Let's use it as much as we can!
- DON'T!
</pre>

<p>
Exception-free code is one of the hardest thing to do right. 
If you don't believe me, check out this question <sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> on StackOverflow. 
Even though the function is simple at first, 
marking it <code>noexcept</code> will make it difficult to change in the future, or break existing client code if changed.
</p>

<p>
Let's see an interesting example.
</p>

<p>
## noexcept and std::vector
</p>

<p>
As you might have known, a <code>vector</code> has its capacity. 
If it's full when <code>push_back</code>, it will allocate a bigger memory, 
copy (or move if C++ 11) all existing elements to the new trunk, 
then add the new element to the back.
</p>


<div class="figure">
<p><img src="./cplusplus-noexcept/copy-construct.png" alt="copy-construct.png" />
</p>
<p><span class="figure-number">Figure 1: </span>Use copy constructor to expand a vector</p>
</div>

<p>
But what if an exception is thrown out while allocating memory, 
or copying the element to the new trunk?
</p>

<ul class="org-ul">
<li>If exception is thrown during allocating memory, the vector is in its original state. 
It's fine just re-throw the exception and let user handle it.</li>

<li><p>
If exception is thrown during copy existing elements, 
all copied elements will be destroyed by calling destructor, 
allocated trunk will be freed, 
and exception thrown out to be handle by user code. <sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>  
</p>

<p>
After destroy everything, the vector is back to the original state. 
Now it's safe to throw exception to let user handle it, without leaking any resource.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org2fdc37c" class="outline-2">
<h2 id="org2fdc37c"><span class="section-number-2">2</span> <code>noexcept</code> and <code>move</code></h2>
<div class="outline-text-2" id="text-2">
<p>
Come to the era of C++ 11, we have a powerful weapon called <code>move</code>. 
It allows us to steal resources from unused objects. 
<code>std::vector</code> will use <code>move</code> when it needs to increase(or decrease) the capacity,
<b>as long as</b> the <code>move</code> operation is <code>noexcept</code>.
</p>

<p>
Suppose an exception throws during the move, the previous trunk is not the same as before <code>move</code> happens: 
resources are stolen, leaving the vector in an <b>broken</b> state. 
User cannot handle the exception because everything is in an nondeterministic state.
</p>


<div class="figure">
<p><img src="./cplusplus-noexcept/move-construct.png" alt="move-construct.png" />
</p>
<p><span class="figure-number">Figure 2: </span>Use move constructor to expand a vector</p>
</div>

<p>
That's why <code>std::vector</code> relies on <code>move constructor</code> to be <code>noexcept</code>.
</p>

<p>
This is a demostration how client code would rely on <code>noexcept</code> as an interface specification. 
If later the <code>noexcept</code> requirement is not met, any code previously depends on it will be broken.
</p>
</div>
</div>


<div id="outline-container-orgd186ab2" class="outline-2">
<h2 id="orgd186ab2"><span class="section-number-2">3</span> noexcept is an interface specification</h2>
<div class="outline-text-2" id="text-3">
<p>
It's easy to add <code>noexcept</code> in the begining, 
but it will be difficult to modify the interface, or remove <code>noexcept</code>.
</p>

<p>
Just like other interface specifications, the principle of when and how to use <code>noexcept</code> should be carefully considered, but in general:
</p>

<pre class="example">
When define an interface, parameter type should be as specific as
possible, and return type should be as specific as possible, so future
modification can be made easily.   

The =noexcept= specification should also be as *generic* as possible,
i.e. =noexcept(false)=.
</pre>
</div>
</div>


<div id="outline-container-org15186d7" class="outline-2">
<h2 id="org15186d7"><span class="section-number-2">4</span> References</h2>
<div class="outline-text-2" id="text-4">
<p>
In the <a href="http://channel9.msdn.com/Events/GoingNative/2013/An-Effective-Cpp11-14-Sampler">An Effective C++11/14 Sampler</a>, Scott Meyers talked about <code>noexcept</code> with above example. It's worth watching.
</p>

<p>
The "<a href="http://stackoverflow.com/a/20521414/2190129">why not noexcept</a>" question on StackOverflow.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="http://stackoverflow.com/questions/1853243/c-do-you-really-write-exception-safe-code">http://stackoverflow.com/questions/1853243/c-do-you-really-write-exception-safe-code</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
What if an exception is thrown during destroying copied elements? <code>std::terminated</code> will be called to terminate the program.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<a href="/" class="left">Home</a><a href="#" class="right">Top</a>
</div>
</body>
</html>
