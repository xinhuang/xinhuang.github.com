<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><title>A better way to integrate NAnt with Jenkins</title></head><body><article id=top class=markdown-body><div layout=row><div flex=30 flex-xs=0 flex-sm=15></div><div flex=40 flex-xs=100 flex-sm=70><h1>A better way to integrate NAnt with Jenkins</h1><div class=metadata></div><hr>
                <h2 id="use-nant-by-nant-plugin-of-jenkins">Use NAnt by NAnt plugin of Jenkins</h2>
<p>As a popular CI tool, <a href="http://jenkins-ci.org/">Jenkins</a> is widely used in many places. <a href="http://nant.sourceforge.net/">NAnt</a> is a popular .NET build tool. If you are using NAnt with Jenkins, you should have been using <a href="https://wiki.jenkins-ci.org/display/JENKINS/NAnt+Plugin">NAnt Plugin</a>.</p>
<h2 id="2-ways-to-load-build-parameters">2 ways to load build parameters</h2>
<p>To pass build parameters to NAnt script, usually there are 2 ways to achieve it:</p>
<h3 id="pass-by-property-through-nant-plugin">Pass by property through NAnt plugin</h3>
<p>After adding a NAnt build step, click the <code>Advanced</code> button, a panel will show up. You can fill desired NAnt properties inside; if you need to access build parameters, you can use <code>$BUILD_PARAM</code>.</p>
<p><img src="/images/posts/a-better-way-to-integrate-nant-with-jenkins/nant-build-step.png" alt="nant-build-step"></p>
<h3 id="load-property-from-environment-variable">Load property from environment variable</h3>
<p>Jenkins will set environment variable according to given build parameters. So you can query them inside NAnt scripts:</p>
<pre class="hljs"><code class="XML"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"${environment::variable-exists('VAR_NAME')}"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"var.name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${environment::get-variable('VAR_NAME')}"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span></code></pre><p>This is handy. Adding 1 configuration parameter just needs to <em>copy</em> above 3 lines.</p>
<p>But soon you will find these 3 similar lines scatterring every where. Especially when your NAnt scripts share lots of common logic, you want to extract all these setting up code into a <code>common.include</code>. Months later, you realize it becomes a monster with hundreds of these <code>test-set</code> lines.</p>
<h2 id="convention-over-configuration">Convention over configuration</h2>
<blockquote>
<p>Ctrl+c Ctrl+v is the root of every evil.</p>
</blockquote>
<p>In our build script, we have following conventions:</p>
<ol>
<li>All Jenkins build parameters are in uppercase, separated by underscore, e.g.:<br><code>FULL_ENSEMBLE_REGISTRATION</code>.</li>
<li>All NAnt script variables are in lowercase, separated by dot, e.g.:<br><code>full.ensemble.registration</code>.</li>
</ol>
<p>When pass build parameters, we load it from environment variables in NAnt scripts. What it does is transforming the uppercase form into the lowercase form.</p>
<p>This gives us opportunities to eliminate those duplications: let NAnt task do the transformation, without breaking existing code or current script guidelines.</p>
<h3 id="load-environment-variables-into-nant-properties">Load environment variables into NAnt properties</h3>
<p>Here is the <a href="https://github.com/xinhuang/NAntEnv">LoadEnvTask</a> project. To use it, call <code>load-environment</code> task in your NAnt script:</p>
<pre class="hljs"><code class="XML"><span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"MyTarget"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">load-environment</span> <span class="hljs-attr">verbose</span>=<span class="hljs-string">"true"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">echo</span> <span class="hljs-attr">message</span>=<span class="hljs-string">"my.var loaded from environment variable: ${my.var}"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span></code></pre><p>And you will see from the log:</p>
<blockquote>
<p>systemdrive = C:<br>programw6432 = C:\Program Files<br>. . .<br>my.var = some value  </p>
</blockquote>
<p>There are other options like specifying which <code>delimeter</code>s to replace, whether to convert everything <code>tolower</code>, from which <code>target</code>, <code>process</code>, <code>user</code> or <code>machine</code>, to load environment variables.</p>
<p>Although all environment variables will be loaded into NAnt properties, and many of them are useless. But usually there is no confliction, so I didn&#39;t add a filter to it. (If you need, PRs are welcome.)</p>

                </div></div><hr><a href=/ class=left>Home</a> <a href=# class=right>Top</a></article><style>body{margin:1em auto;max-width:40em;padding:0 .62em;font:1.2em/1.62em sans-serif;background-color:#f0efd1}h1,h2,h3{line-height:1.2em}@media print{body{max-width:none}}a{text-decoration:none}article{margin:auto;font-size:14px;padding:3px 1em}.metadata{color:rgba(0,0,0,.54)}hr{display:block;height:1px;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}.left{float:left}.right{float:right}</style><link rel=stylesheet href=/github-markdown.css><link rel=stylesheet href=/zenburn.css></body><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-42274645-1","auto"),ga("send","pageview")</script></html>